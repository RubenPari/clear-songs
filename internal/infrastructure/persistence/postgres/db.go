/**
 * Database Package
 *
 * This package handles database connection and initialization using GORM
 * (Go Object-Relational Mapping) with PostgreSQL as the database backend.
 *
 * The package provides:
 * - Database connection management
 * - Automatic schema migration
 * - Global database instance for use throughout the application
 *
 * Database Schema:
 * The package uses GORM's AutoMigrate feature to automatically create and
 * update database tables based on model definitions. Currently manages:
 * - TrackDB model: Stores track metadata and user library information
 *
 * Connection Configuration:
 * Database credentials are loaded from environment variables:
 * - DB_HOST: Database host address
 * - DB_PORT: Database port number
 * - DB_USER: Database username
 * - DB_PASSWORD: Database password
 * - DB_NAME: Database name
 *
 * @package postgres
 * @author Clear Songs Development Team
 */
package postgres

import (
	"fmt"
	"log"
	"os"

	"github.com/RubenPari/clear-songs/internal/infrastructure/persistence/postgres/models"
	"gorm.io/driver/postgres"
	"gorm.io/gorm"
)

/**
 * Global Database Instance
 *
 * This variable holds the GORM database connection instance.
 * It is initialized by the Init() function and can be accessed
 * throughout the application for database operations.
 *
 * The variable is set to nil initially and will be assigned
 * a valid database connection after successful initialization.
 */
var Db *gorm.DB = nil

// Init connects to the Postgres database and performs auto-migration to create the
// tables as necessary. It sets the Db global variable to the connected database.
//
// This function returns an error if it fails to connect to the database, test the
// connection, or perform the auto-migration. If the function is successful, it
// will log a message to the console indicating that the database connection was
// successful.
func Init() error {
	// postgres credentials
	host := os.Getenv("DB_HOST")
	port := os.Getenv("DB_PORT")
	user := os.Getenv("DB_USER")
	password := os.Getenv("DB_PASSWORD")
	dbname := os.Getenv("DB_NAME")

	// Check if database configuration is provided
	if host == "" || port == "" || user == "" || password == "" || dbname == "" {
		log.Println("WARNING: Database environment variables not set (DB_HOST, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME)")
		log.Println("WARNING: Application will continue without database. Backup functionality will be disabled.")
		log.Println("WARNING: To enable database, set the required environment variables and restart the application.")
		return nil // Return nil to allow application to continue without database
	}

	// create the connection string
	postgresInfo := fmt.Sprintf("host=%s port=%s user=%s password=%s dbname=%s", host, port, user, password, dbname)

	// Open the connection
	var errConnectDb error
	db, errConnectDb := gorm.Open(postgres.Open(postgresInfo), &gorm.Config{})

	if errConnectDb != nil {
		log.Printf("WARNING: Database connection failed: %v", errConnectDb)
		log.Println("WARNING: Application will continue without database. Backup functionality will be disabled.")
		return nil // Return nil to allow application to continue without database
	}

	// test connection
	errTestDb := db.Exec("SELECT 1").Error

	if errTestDb != nil {
		log.Printf("WARNING: Database connection test failed: %v", errTestDb)
		log.Println("WARNING: Application will continue without database. Backup functionality will be disabled.")
		return nil // Return nil to allow application to continue without database
	}

	// auto-migration
	errMigration := db.AutoMigrate(&models.TrackDB{})

	if errMigration != nil {
		log.Printf("WARNING: Database migration failed: %v", errMigration)
		log.Println("WARNING: Application will continue without database. Backup functionality will be disabled.")
		return nil // Return nil to allow application to continue without database
	}

	Db = db

	log.Println("Successfully connected to database!")

	return nil
}
